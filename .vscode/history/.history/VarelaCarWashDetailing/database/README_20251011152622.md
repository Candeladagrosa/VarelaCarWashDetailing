# Sistema RBAC - InstalaciÃ³n y ConfiguraciÃ³n

## ğŸ“‹ DescripciÃ³n

Sistema de Control de Acceso Basado en Roles (RBAC) para Varela Car Wash & Detailing con auditorÃ­a completa.

## ğŸ—„ï¸ Estructura de la Base de Datos

### Tablas Principales

1. **roles** - CatÃ¡logo de roles del sistema
2. **permisos** - Permisos granulares por mÃ³dulo
3. **rol_permisos** - AsignaciÃ³n de permisos a roles (relaciÃ³n N:N)
4. **auditoria** - Registro de todos los cambios en el sistema

### Roles Predefinidos

| Rol | ID | DescripciÃ³n |
|-----|----|----|
| Administrador | 1 | Acceso completo a todas las funcionalidades |
| Vendedor | 2 | GestiÃ³n de turnos y pedidos, vista de productos/servicios |
| Cliente | 3 | Compra de productos y reserva de turnos |

### MÃ³dulos y Permisos

- **productos**: ver_listado, crear, editar, eliminar, cambiar_estado
- **servicios**: ver_listado, crear, editar, eliminar, cambiar_estado
- **usuarios**: ver_listado, crear, editar, eliminar, cambiar_rol, ver_detalles
- **turnos**: ver_listado, ver_propios, crear, editar, eliminar, cambiar_estado
- **pedidos**: ver_listado, ver_propios, crear, editar, eliminar, cambiar_estado
- **roles**: ver_listado, crear, editar, eliminar, asignar_permisos
- **auditoria**: ver_listado, ver_propia

## ğŸš€ InstalaciÃ³n en Supabase

### Paso 1: Ejecutar Esquema de Base de Datos

En el SQL Editor de Supabase, ejecuta los archivos en este orden:

```sql
-- 1. Crear tablas y polÃ­ticas RLS
\i rbac_schema.sql

-- 2. Insertar datos iniciales (roles y permisos)
\i rbac_seed.sql

-- 3. Configurar sistema de auditorÃ­a
\i rbac_audit.sql
```

**Nota**: Si estÃ¡s usando la interfaz web de Supabase:
1. Abre cada archivo `.sql`
2. Copia y pega el contenido completo
3. Ejecuta en el SQL Editor
4. Verifica que no haya errores

### Paso 2: Verificar InstalaciÃ³n

Ejecuta estas consultas para verificar:

```sql
-- Ver roles creados
SELECT * FROM public.roles ORDER BY id_rol;

-- Ver cantidad de permisos
SELECT COUNT(*) as total_permisos FROM public.permisos;

-- Ver permisos por rol
SELECT 
    r.nombre as rol,
    COUNT(rp.id_permiso) as permisos_asignados
FROM public.roles r
LEFT JOIN public.rol_permisos rp ON r.id_rol = rp.id_rol
GROUP BY r.id_rol, r.nombre
ORDER BY r.id_rol;
```

**Resultados esperados:**
- 3 roles creados (Administrador, Vendedor, Cliente)
- Aproximadamente 35 permisos en total
- Administrador: ~35 permisos
- Vendedor: ~9 permisos
- Cliente: ~6 permisos

### Paso 3: Actualizar Perfiles Existentes

Si ya tienes usuarios en la tabla `perfiles`, asigna roles apropiados:

```sql
-- Asignar rol de Cliente a todos los usuarios sin rol
UPDATE public.perfiles 
SET id_rol = 3 
WHERE id_rol IS NULL;

-- Verificar
SELECT 
    p.nombre,
    p.apellido,
    p.email,
    r.nombre as rol
FROM public.perfiles p
LEFT JOIN public.roles r ON p.id_rol = r.id_rol;
```

## ğŸ” Funciones Ãštiles

### Obtener permisos de un usuario

```sql
SELECT * FROM public.get_user_permissions('user-uuid-here');
```

### Verificar si un usuario tiene un permiso

```sql
SELECT public.user_has_permission('user-uuid-here', 'productos.crear');
```

### Ver auditorÃ­a detallada

```sql
SELECT * FROM public.v_auditoria_detallada LIMIT 50;
```

### Ver cambios recientes (Ãºltimos 7 dÃ­as)

```sql
SELECT * FROM public.v_auditoria_reciente;
```

### Ver estadÃ­sticas de auditorÃ­a

```sql
SELECT * FROM public.v_auditoria_estadisticas;
```

## ğŸ” Row Level Security (RLS)

Todas las tablas tienen RLS habilitado con las siguientes polÃ­ticas:

- **roles**: Todos pueden ver roles activos, solo admins pueden modificar
- **permisos**: Todos pueden ver, solo admins pueden modificar
- **rol_permisos**: Todos pueden ver, solo admins pueden modificar
- **auditoria**: Los usuarios ven su propia auditorÃ­a, admins ven todo

## ğŸ“ PrÃ³ximos Pasos

DespuÃ©s de instalar la base de datos:

1. âœ… Actualizar el contexto de autenticaciÃ³n (`SupabaseAuthContext.jsx`)
2. âœ… Crear hook `usePermissions`
3. âœ… Crear componente `ProtectedRoute`
4. âœ… Crear componente `PermissionGuard`
5. âœ… Implementar ABM de Roles (`RolesAdmin.jsx`)
6. âœ… Implementar asignaciÃ³n de permisos (`PermissionsAdmin.jsx`)
7. âœ… Proteger componentes existentes
8. âœ… Crear pÃ¡gina de historial para clientes

## ğŸ› ï¸ Mantenimiento

### Agregar un nuevo permiso

```sql
INSERT INTO public.permisos (codigo, nombre, descripcion, modulo, accion) 
VALUES ('nuevo_modulo.accion', 'Nombre del Permiso', 'DescripciÃ³n', 'modulo', 'accion');
```

### Asignar permiso a un rol

```sql
INSERT INTO public.rol_permisos (id_rol, id_permiso)
SELECT 1, id_permiso FROM public.permisos WHERE codigo = 'nuevo_modulo.accion';
```

### Crear un nuevo rol

```sql
INSERT INTO public.roles (nombre, descripcion, es_sistema, activo)
VALUES ('Nuevo Rol', 'DescripciÃ³n del rol', false, true);
```

## âš ï¸ Advertencias

- **NO** elimines roles del sistema (`es_sistema = true`)
- **NO** modifiques directamente la tabla `auditoria` (se llena automÃ¡ticamente)
- Siempre verifica los permisos antes de eliminar un rol
- Los cambios en permisos de roles se reflejan inmediatamente

## ğŸ“ Soporte

Si encuentras algÃºn error durante la instalaciÃ³n:
1. Revisa los logs del SQL Editor
2. Verifica que todas las tablas se crearon correctamente
3. AsegÃºrate de ejecutar los scripts en orden
4. Verifica las polÃ­ticas RLS en Settings > Policies
