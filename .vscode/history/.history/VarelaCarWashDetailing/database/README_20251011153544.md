# Sistema RBAC - Instalación y Configuración

## 📋 Descripción

Sistema de Control de Acceso Basado en Roles (RBAC) para Varela Car Wash & Detailing con auditoría completa.

## 🗄️ Estructura de la Base de Datos

### Tablas Principales

1. **roles** - Catálogo de roles del sistema
2. **permisos** - Permisos granulares por módulo
3. **rol_permisos** - Asignación de permisos a roles (relación N:N)
4. **auditoria** - Registro de todos los cambios en el sistema

### Roles Predefinidos

| Rol | ID | Descripción |
|-----|----|----|
| Administrador | 1 | Acceso completo a todas las funcionalidades |
| Vendedor | 2 | Gestión de turnos y pedidos, vista de productos/servicios |
| Cliente | 3 | Compra de productos y reserva de turnos |

### Módulos y Permisos

- **productos**: ver_listado, crear, editar, eliminar, cambiar_estado
- **servicios**: ver_listado, crear, editar, eliminar, cambiar_estado
- **usuarios**: ver_listado, crear, editar, eliminar, cambiar_rol, ver_detalles
- **turnos**: ver_listado, ver_propios, crear, editar, eliminar, cambiar_estado
- **pedidos**: ver_listado, ver_propios, crear, editar, eliminar, cambiar_estado
- **roles**: ver_listado, crear, editar, eliminar, asignar_permisos
- **auditoria**: ver_listado, ver_propia

## 🚀 Instalación en Supabase

### Paso 1: Ejecutar Esquema de Base de Datos

En el SQL Editor de Supabase, ejecuta los archivos en este orden:

```sql
-- 1. Crear tablas y políticas RLS
\i rbac_schema.sql

-- 2. Insertar datos iniciales (roles y permisos)
\i rbac_seed.sql

-- 3. Configurar sistema de auditoría
\i rbac_audit.sql
```

**Nota**: Si estás usando la interfaz web de Supabase:
1. Abre cada archivo `.sql`
2. Copia y pega el contenido completo
3. Ejecuta en el SQL Editor
4. Verifica que no haya errores

### Paso 2: Verificar Instalación

Ejecuta estas consultas para verificar:

```sql
-- Ver roles creados
SELECT * FROM public.roles ORDER BY id_rol;

-- Ver cantidad de permisos
SELECT COUNT(*) as total_permisos FROM public.permisos;

-- Ver permisos por rol
SELECT 
    r.nombre as rol,
    COUNT(rp.id_permiso) as permisos_asignados
FROM public.roles r
LEFT JOIN public.rol_permisos rp ON r.id_rol = rp.id_rol
GROUP BY r.id_rol, r.nombre
ORDER BY r.id_rol;
```

**Resultados esperados:**
- 3 roles creados (Administrador, Vendedor, Cliente)
- Aproximadamente 35 permisos en total
- Administrador: ~35 permisos
- Vendedor: ~9 permisos
- Cliente: ~6 permisos

### Paso 3: Actualizar Perfiles Existentes

Si ya tienes usuarios en la tabla `perfiles`, asigna roles apropiados:

```sql
-- Asignar rol de Cliente a todos los usuarios sin rol
UPDATE public.perfiles 
SET id_rol = 3 
WHERE id_rol IS NULL;

-- Verificar
SELECT 
    p.nombre,
    p.apellido,
    p.email,
    r.nombre as rol
FROM public.perfiles p
LEFT JOIN public.roles r ON p.id_rol = r.id_rol;
```

## 🔍 Funciones Útiles

### Obtener permisos de un usuario

```sql
SELECT * FROM public.get_user_permissions('user-uuid-here');
```

### Verificar si un usuario tiene un permiso

```sql
SELECT public.user_has_permission('user-uuid-here', 'productos.crear');
```

### Ver auditoría detallada

```sql
SELECT * FROM public.v_auditoria_detallada LIMIT 50;
```

### Ver cambios recientes (últimos 7 días)

```sql
SELECT * FROM public.v_auditoria_reciente;
```

### Ver estadísticas de auditoría

```sql
SELECT * FROM public.v_auditoria_estadisticas;
```

## 🔐 Row Level Security (RLS)

Todas las tablas tienen RLS habilitado con las siguientes políticas:

- **roles**: Todos pueden ver roles activos, solo admins pueden modificar
- **permisos**: Todos pueden ver, solo admins pueden modificar
- **rol_permisos**: Todos pueden ver, solo admins pueden modificar
- **auditoria**: Los usuarios ven su propia auditoría, admins ven todo

## 📝 Próximos Pasos

Después de instalar la base de datos:

1. ✅ Actualizar el contexto de autenticación (`SupabaseAuthContext.jsx`)
2. ✅ Crear hook `usePermissions`
3. ✅ Crear componente `ProtectedRoute`
4. ✅ Crear componente `PermissionGuard`
5. ✅ Implementar ABM de Roles (`RolesAdmin.jsx`)
6. ✅ Implementar asignación de permisos (`PermissionsAdmin.jsx`)
7. ✅ Proteger componentes existentes
8. ✅ Crear página de historial para clientes

## 🛠️ Mantenimiento

### Agregar un nuevo permiso

```sql
INSERT INTO public.permisos (codigo, nombre, descripcion, modulo, accion) 
VALUES ('nuevo_modulo.accion', 'Nombre del Permiso', 'Descripción', 'modulo', 'accion');
```

### Asignar permiso a un rol

```sql
INSERT INTO public.rol_permisos (id_rol, id_permiso)
SELECT 1, id_permiso FROM public.permisos WHERE codigo = 'nuevo_modulo.accion';
```

### Crear un nuevo rol

```sql
INSERT INTO public.roles (nombre, descripcion, es_sistema, activo)
VALUES ('Nuevo Rol', 'Descripción del rol', false, true);
```

## ⚠️ Advertencias

- **NO** elimines roles del sistema (`es_sistema = true`)
- **NO** modifiques directamente la tabla `auditoria` (se llena automáticamente)
- Siempre verifica los permisos antes de eliminar un rol
- Los cambios en permisos de roles se reflejan inmediatamente

## 📞 Soporte

Si encuentras algún error durante la instalación:
1. Revisa los logs del SQL Editor
2. Verifica que todas las tablas se crearon correctamente
3. Asegúrate de ejecutar los scripts en orden
4. Verifica las políticas RLS en Settings > Policies
